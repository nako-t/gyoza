---
import Layout from "@/layouts/Layout.astro";
import "@/pages/search/index.scss";

const data = [
  {
    img: "",
    shopName: "餃子",
    location: "渋谷",
    description: "美味しい",
  },
  {
    img: "",
    shopName: "",
    location: "",
    description: "美味しい",
  },
  {
    img: "",
    shopName: "",
    location: "",
    description: "美味しい",
  },
];
---

<Layout>

  <div class="search is-active" data-tab-content="list">
    {
      data.map((item, index) => (
        <div class="search__item" data-shop-modal="open" data-slideid={index}>
          <img src="" alt="" width="300" height="300" class="search__shopImg" />
          <h3 class="search__shopName">{item.shopName}</h3>
          <span class="search__location">{item.location}</span>
        </div>
      ))
    }
    <dialog class="shopModal" data-shop-modal="dialog">
      <button class="shopModal__closeButton" data-shop-modal="close"
        >閉じる</button
      >
      <div class="shopModal__slider">
        <div class="shopModal__slideWrapper" data-shop-modal="slideWrapper">
          {
            data.map((item, index) => (
              <div class="shopModal__slide" data-shop-modal="slide">
                <div class="shopModal__content">
                  <img src="" alt="" width="250" height="250" loading="lazy" />
                  <div class="shopModal__description">
                    <span>{item.shopName + index}</span>
                    <span>{item.location}</span>
                    <p>{item.description}</p>
                  </div>
                </div>
              </div>
            ))
          }
        </div>
      </div>
      <button
        class="shopModal__nextButton shopModal__slideButton"
        data-shop-modal="next"></button>
      <button
        class="shopModal__prevButton shopModal__slideButton"
        data-shop-modal="prev"></button>
    </dialog>
  </div>
  <div class="map" data-tab-content="map">
    <p>map</p>
  </div>

  <script>
    // スライダーのファクトリー関数（アロー関数式）
    const createSlider = (wrapperSelector: string, slideSelector: string) => {
      let currentIndex = 0;
      const slideWrapper = document.querySelector<HTMLElement>(wrapperSelector);
      const slides = document.querySelectorAll(slideSelector);
      const totalSlides = slides.length;

      const goTo = (index: number) => {
        currentIndex = index;
        update();
      };

      const next = () => {
        currentIndex = (currentIndex + 1) % totalSlides;
        update();
      };

      const prev = () => {
        currentIndex = (currentIndex - 1 + totalSlides) % totalSlides;
        update();
      };

      const update = () => {
        if (slideWrapper) {
          slideWrapper.style.transform = `translateX(${-currentIndex * 100}%)`;
        }
      };

      return { goTo, next, prev, update };
    };

    // モーダルのファクトリー関数（アロー関数式）
    const createModal = (dialogSelector: string, closeSelector: string) => {
      const dialog = document.querySelector<HTMLDialogElement>(dialogSelector);
      const closeButton = document.querySelector(closeSelector);

      const open = () => {
        dialog?.showModal();
      };

      const close = () => {
        dialog?.close();
      };

      closeButton?.addEventListener("click", close);
      dialog?.addEventListener("click", (e) => {
        if (e.target === dialog) close();
      });

      return { open, close };
    };

    // --- 初期化・連携 ---
    (() => {
      const slider = createSlider(
        '[data-shop-modal="slideWrapper"]',
        '[data-shop-modal="slide"]'
      );
      const modal = createModal(
        '[data-shop-modal="dialog"]',
        '[data-shop-modal="close"]'
      );

      // モーダルトリガー
      document
        .querySelectorAll<HTMLElement>('[data-shop-modal="open"]')
        .forEach((toggle) => {
          toggle.addEventListener("click", () => {
            const slideId = Number(toggle.dataset.slideid) || 0;
            slider.goTo(slideId);
            modal.open();
          });
        });

      // スライドボタン
      document
        .querySelector('[data-shop-modal="next"]')
        ?.addEventListener("click", slider.next);
      document
        .querySelector('[data-shop-modal="prev"]')
        ?.addEventListener("click", slider.prev);
    })();
  </script>
</Layout>
